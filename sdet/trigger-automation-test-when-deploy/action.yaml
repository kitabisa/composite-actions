name: "trigger automation test when deploy completed"
description: "build and trigger automation test api when deploy completed"

inputs:
  gh_token:
    required: true
    description: "gh token"
    default: "false"
    type: string

  setup_pnpm:
    required: false
    description: "setup pnpm"
    default: "false"
    type: string

  setup_bun:
    required: false
    description: "setup bun"
    default: "false"
    type: string

  setup_gh_cli:
    required: false
    description: "setup gh cli"
    default: "false"
    type: string

  service_name:
    required: false
    description: "service name"
    default: "false"
    type: string

  trigger_automation_test_api_when_deploy:
    required: false
    description: "trigger automation test api when deploy"
    default: "false"
    type: string

  pr_author:
    required: false
    description: "author of the pull request"
    default: "unknown author"
    type: string

  pr_link:
    required: false
    description: "link to the pull request"
    default: "not available"
    type: string

  pr_info:
    required: false
    description: "get author and link pr"
    default: "false"
    type: string

runs:
  using: "composite"
  steps:
    - name: delay
      shell: bash
      if: "${{ inputs.trigger_automation_test_api_when_deploy == 'true' }}"
      run: sleep 300

    - name: setup tools sdet
      uses: kitabisa/composite-actions/sdet/tools/setup-tools@v2
      with:
        setup_pnpm: ${{ inputs.setup_pnpm }}
        setup_bun: ${{ inputs.setup_bun }}
        setup_gh_cli: ${{ inputs.setup_gh_cli }}

    - name: get pr link and author
      shell: bash
      if: "${{ inputs.pr_info == 'true' }}"
      run: |
        PR_AUTHOR=$(gh pr view --json author --jq '.author.login')
        PR_LINK=$(gh pr view --json url --jq '.url')
        echo "PR_AUTHOR=$PR_AUTHOR" >> $GITHUB_ENV
        echo "PR_LINK=$PR_LINK" >> $GITHUB_ENV
      env:
        GITHUB_TOKEN: ${{ inputs.gh_token }}

    - name: trigger automation test api when deploy completed
      shell: bash
      if: "${{ inputs.trigger_automation_test_api_when_deploy == 'true' }}"
      run: |
        gh workflow run -R kitabisa/qorin .github/workflows/trigger-when-deploy.yaml \
          -f profile=${{ inputs.service_name }} \
          -f pr_author="${PR_AUTHOR}" \
          -f pr_link="${PR_LINK}" \
          --ref chore/sdet-1317-add-url-and-author-pr-to-slack-report
      env:
        GITHUB_TOKEN: ${{ inputs.gh_token }}
